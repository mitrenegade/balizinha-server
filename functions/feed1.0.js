// types supported by mobile client:
// chat
// photo
// other
// action

exports.createFeedItem = function(req, res, exports, admin) {
	let type = req.body.type
    let feedItemId = req.body.id
	let userId = req.body.userId
	let leagueId = req.body.leagueId
	let eventId = req.body.eventId
	let message = req.body.message
	let defaultMessage = req.body.defaultMessage
    console.log("createFeedItem type: " + type + " league id: " + leagueId + " event id: " + eventId + " message: " + message)

    return doCreateFeedItem(feedItemId, type, userId, leagueId, eventId, message, defaultMessage, exports, admin).then(feedItem => {
        // create eventAction
        // BOBBY TODO: when a chat is created under event, a feedItem should be created with a different type than message or photo
        // create feedItem with type eventChat, with actionId
        // feedItems loaded with actionId should load the action and display it
        // or, events with actionId that is actually a feedItem should load a feedItem instead
        return exports.pushForLeagueFeedItem(leagueId, type, userId, message)
    }).then(() => {
    	res.status(200).json({"result": "success"})
    }).catch(function(error) {
    	res.status(500).json({"error": error.message})
    })
}

exports.createFeedItemForJoinLeaveLeague = function(userId, leagueId, isJoin, exports, admin) {
    // create a feed item when something happens in the league, ie join
    var type = "action"
    var name = "Someone"
    let ref = `/players/` + userId
    return admin.database().ref(ref).once('value').then(snapshot => {
        if (!snapshot.exists()) {
            return // do not create feedItem
        }
        name = snapshot.val().name
        let ref = `/leagues/` + leagueId
        return admin.database().ref(ref).once('value')
    }).then(snapshot => {
        if (!snapshot.exists()) {
            return
        }
        let league = snapshot.val().name
        var joinString = " joined "
        if (!isJoin) {
            joinString = " left "
        }
        let message = name + joinString + league
        let defaultMessage = message
        let id = exports.createUniqueId()
        console.log("createFeedItemForJoinLeague 1.0: creating feedItem with message " + message)
        return doCreateFeedItem(id, type, userId, leagueId, undefined, message, defaultMessage, exports, admin)
    })
}

doCreateFeedItem = function(id, type, userId, leagueId, eventId, message, defaultMessage, exports, admin) {
    
    var params = {"userId": userId}
    var feedItemId = id // unique id might be generated by image upload
    if (id == undefined) {
        feedItemId = exports.createUniqueId()
    }
    params["type"] = type
    if (leagueId != undefined) {
	    params["leagueId"] = leagueId
	}
	if (eventId != undefined) {
	    params["eventId"] = eventId
	}
    if (message != undefined) {
        params["message"] = message
    }
    var createdAt = exports.secondsSince1970()
    params["createdAt"] = createdAt
    if (defaultMessage != undefined) {
        params["defaultMessage"] = defaultMessage
    }

    var ref = `/feedItems/` + feedItemId
    return admin.database().ref(ref).set(params)
}
